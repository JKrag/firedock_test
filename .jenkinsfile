// Add env variables
// Build image
// Run image
// End-to-end test

node {
	stage('checkout'){
		checkout scm
	}
	stage('R check') {
		sh 'docker build --pull --no-cache -t fiery-check:latest -f Dockerfile_check .'
		sh 'docker container create --name firecheck fiery-check'
		sh 'docker cp firecheck:check_result check_result'
		sh 'docker cp firecheck:firedock.Rcheck check_artefacts'
		sh 'docker rm firecheck'
		sh 'tar czf check_artefacts.tar.gz check_artefacts'
		archive 'check_artefacts.tar.gz'
		sh 'grep SUCCESS check_result'
	}
	stage('build docker image'){
		sh 'docker build --build-arg root="${BRANCH_NAME}" -t fiery-test:latest . '
	}
}
node {
	stage("run docker"){
		sh 'docker container run --name mylittlefiery --rm -p 8000:8080 fiery-test &'
	}
	stage("test docker") {
		try {		
			sh 'sleep 5'
			out = sh(returnStdout: true, script: 'curl -s http://127.0.0.1:8000/${BRANCH_NAME}/hello/world/')
			echo out
			if (out ==  "<h1>Hello world!</h1>[Pipeline]") {
				exit 1
			}
		} catch (e) {
			currentBuild.result = 'FAILURE'
			throw e
		} finally {
			sh "docker container kill mylittlefiery"
		}
	}
}
