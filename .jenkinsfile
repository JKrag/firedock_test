// Add env variables
// Build image
// Run image
// End-to-end test

node {
	stage('checkout'){
		checkout scm
	}
	stage('build docker image'){
		sh 'docker build --build-arg root="${BRANCH_NAME}" -t fiery-test:latest . '
	}
}
node {
	stage("run docker"){
		sh 'docker container run --name mylittlefiery --rm -p 8000:8080 fiery-test &'
	}
	stage("test docker") {
		try {		
			sh 'sleep 5'
			out = sh(returnStdout: true, script: 'curl -s http://127.0.0.1:8000/${BRANCH_NAME}/hello/world/')
			echo out
			if (out ==  "<h1>Hello world!</h1>[Pipeline]") {
				exit 1
			}
		} catch (e) {
			currentBuild.result = 'FAILURE'
			throw e
		} finally {
			sh "docker container kill mylittlefiery"
		}
	}
}